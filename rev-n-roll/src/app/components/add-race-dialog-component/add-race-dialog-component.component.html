<div class="dialog-container">
    <mat-icon class="race-icon">flag</mat-icon>
    <h2 class="dialog-title">{{ isEditMode ? 'Edit Race' : 'Create a New Race' }}</h2>
    <form [formGroup]="raceForm" (ngSubmit)="onSubmit()" class="form-content">
      <mat-form-field appearance="fill" class="w-full">
        <mat-label>Race Name</mat-label>
        <input matInput formControlName="name" required>
        <mat-error *ngIf="raceForm.get('name')?.hasError('required')">
          Race name is required
        </mat-error>
        <mat-error *ngIf="raceForm.get('name')?.hasError('minlength')">
          Race name must be at least 2 characters
        </mat-error>
        <mat-error *ngIf="raceForm.get('name')?.hasError('maxlength')">
          Race name cannot exceed 64 characters
        </mat-error>
      </mat-form-field>
  
      <mat-form-field appearance="fill" class="w-full">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" rows="3"></textarea>
        <mat-error *ngIf="raceForm.get('description')?.hasError('maxlength')">
          Description cannot exceed 500 characters
        </mat-error>
      </mat-form-field>
  
      <mat-form-field appearance="fill" class="w-full">
        <mat-label>Crew ID (optional)</mat-label>
        <input matInput type="number" formControlName="crewId">
      </mat-form-field>
  
      <mat-form-field appearance="fill" class="w-full">
        <mat-label>Race Type</mat-label>
        <mat-select formControlName="raceType" required>
          <mat-option *ngFor="let type of raceTypeOptions" [value]="type">
            {{ type }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="raceForm.get('raceType')?.hasError('required')">
          Race Type is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="w-full">
        <mat-label>Location</mat-label>
        <input matInput formControlName="location" required>
        <mat-error *ngIf="raceForm.get('location')?.hasError('required')">
          Location is required
        </mat-error>
        <mat-error *ngIf="raceForm.get('location')?.hasError('maxlength')">
          Location cannot exceed 128 characters
        </mat-error>
      </mat-form-field>
  
      <div class="location-selection">
        <button mat-raised-button color="accent" type="button" (click)="openMapDialog()">
          <mat-icon>location_on</mat-icon>
          Select Location on Map
        </button>
        <p *ngIf="raceForm.get('latitude')?.value && raceForm.get('longitude')?.value" class="text-gray-300 mt-2">
          Selected: ({{ raceForm.get('latitude')?.value.toFixed(4) }}, {{ raceForm.get('longitude')?.value.toFixed(4) }})
        </p>
        <mat-error *ngIf="raceForm.get('latitude')?.hasError('required') || raceForm.get('longitude')?.hasError('required')">
          Location coordinates are required
        </mat-error>
      </div>
  
      <mat-form-field appearance="fill" class="w-full">
        <mat-label>Race Date</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="date" required>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
        <mat-error *ngIf="raceForm.get('date')?.hasError('required')">
          Race date is required
        </mat-error>
      </mat-form-field>
  
      <mat-form-field appearance="fill" class="w-full">
        <mat-label>Race Time</mat-label>
        <input matInput type="time" formControlName="time" required>
        <mat-error *ngIf="raceForm.get('time')?.hasError('required')">
          Race time is required
        </mat-error>
      </mat-form-field>
  
      <mat-checkbox formControlName="private" color="primary">
        Private Race
      </mat-checkbox>
  
      <div class="button-container">
        <button mat-button type="button" class="cancel-button" (click)="onCancel()">Cancel</button>
        <button mat-raised-button type="submit" color="primary" class="submit-button" [disabled]="raceForm.invalid || isSubmitting">
          <mat-spinner diameter="20" *ngIf="isSubmitting"></mat-spinner>
          <span *ngIf="!isSubmitting">{{ isEditMode ? 'Update Race' : 'Create Race' }}</span>
        </button>
      </div>
    </form>
  </div>